#include <stdio.h>
#include <stdint.h>

/* Analysis of Tesla CRC calculation

Discussion: https://openinverter.org/forum/viewtopic.php?p=81258#p81258

Data from original car:
Frames crcCenter:
0x229 0x46 0x00 0x00
0x229 0x44 0x01 0x00
0x229 0x52 0x02 0x00
0x229 0x6D 0x03 0x00
0x229 0x43 0x04 0x00
0x229 0x41 0x05 0x00
0x229 0xDD 0x06 0x00
0x229 0xF9 0x07 0x00
0x229 0x4C 0x08 0x00
0x229 0xA5 0x09 0x00
0x229 0xF6 0x0A 0x00
0x229 0x8C 0x0B 0x00
0x229 0x49 0x0C 0x00
0x229 0x2F 0x0D 0x00
0x229 0x31 0x0E 0x00
0x229 0x3B 0x0F 0x00

Frames crcFullDown:
0x229 0xB7 0x40 0x00
0x229 0xB5 0x41 0x00
0x229 0xA3 0x42 0x00
0x229 0x9C 0x43 0x00
0x229 0xB2 0x44 0x00
0x229 0xB0 0x45 0x00
0x229 0x2C 0x46 0x00
0x229 0x08 0x47 0x00
0x229 0xBD 0x48 0x00
0x229 0x54 0x49 0x00
0x229 0x07 0x4A 0x00
0x229 0x7D 0x4B 0x00
0x229 0xB8 0x4C 0x00
0x229 0xDE 0x4D 0x00
0x229 0xC0 0x4E 0x00
0x229 0xCA 0x4F 0x00

Frames crcParkButton:
0x229 0xAF 0x00 0x01
0x229 0xAD 0x01 0x01
0x229 0xBB 0x02 0x01
0x229 0x84 0x03 0x01
0x229 0xAA 0x04 0x01
0x229 0xA8 0x05 0x01
0x229 0x34 0x06 0x01
0x229 0x10 0x07 0x01
0x229 0xA5 0x08 0x01
0x229 0x4C 0x09 0x01
0x229 0x1F 0x0A 0x01
0x229 0x65 0x0B 0x01
0x229 0xA0 0x0C 0x01
0x229 0xC6 0x0D 0x01
0x229 0xD8 0x0E 0x01
0x229 0xD2 0x0F 0x01

Frames crcFullUp:
0x229 0xA9 0x20 0x00
0x229 0xAB 0x21 0x00
0x229 0xBD 0x22 0x00
0x229 0x82 0x23 0x00
0x229 0xAC 0x24 0x00
0x229 0xAE 0x25 0x00
0x229 0x32 0x26 0x00
0x229 0x16 0x27 0x00
0x229 0xA3 0x28 0x00
0x229 0x4A 0x29 0x00
0x229 0x19 0x2A 0x00
0x229 0x63 0x2B 0x00
0x229 0xA6 0x2C 0x00
0x229 0xC0 0x2D 0x00
0x229 0xDE 0x2E 0x00
0x229 0xD4 0x2F 0x00

Frames crcHalfDown:
0x229 0x49 0x30 0x00
0x229 0x4B 0x31 0x00
0x229 0x5D 0x32 0x00
0x229 0x62 0x33 0x00
0x229 0x4C 0x34 0x00
0x229 0x4E 0x35 0x00
0x229 0xD2 0x36 0x00
0x229 0xF6 0x37 0x00
0x229 0x43 0x38 0x00
0x229 0xAA 0x39 0x00
0x229 0xF9 0x3A 0x00
0x229 0x83 0x3B 0x00
0x229 0x46 0x3C 0x00
0x229 0x20 0x3D 0x00
0x229 0x3E 0x3E 0x00
0x229 0x34 0x3F 0x00

*/

/* The magicBytes of the message 0x229. This is the value of the CRC byte, while the stick is in idle position. */
uint8_t magicBytes[16] = { 0x46, 0x44, 0x52, 0x6D, 0x43, 0x41, 0xDD, 0xF9, 0x4C, 0xA5, 0xF6, 0x8C, 0x49, 0x2F, 0x31, 0x3B };

uint8_t isFullDown;
uint8_t isParkButton;
uint8_t isFullUp;
uint8_t isHalfDown;

uint8_t canMessage[3];

void createCanMessage(uint8_t alivecounter) {
  uint8_t crc;
  uint8_t xorpattern;
  xorpattern = 0;
  /* step 1: fill-in the alive counter, and clear all button bits */
  canMessage[1] = alivecounter;
  canMessage[2] = 0;
  /* step 2: fill-in the button-bits */
  if (isFullDown) {
      canMessage[1] |= 0x40;
      xorpattern = 0x46 ^ 0xB7; /* the xor-difference between the measured CRC in idle and in pressed state */
  }
  if (isParkButton) {
      canMessage[2] |= 0x01;
      xorpattern = 0x46 ^ 0xAF; /* the xor-difference between the measured CRC in idle and in pressed state */
  }
  if (isFullUp) {
      canMessage[1] |= 0x20;
      xorpattern = 0x46 ^ 0xA9; /* the xor-difference between the measured CRC in idle and in pressed state */
  }
  if (isHalfDown) {
      canMessage[1] |= 0x30;
      xorpattern = 0x46 ^ 0x49; /* the xor-difference between the measured CRC in idle and in pressed state */
  }
  /* step 3: take the basic CRC from the magic-pattern-table, and add the individual XOR pattern */
  crc = magicBytes[alivecounter] ^ xorpattern;
  canMessage[0] = crc;
}

void printMessages(void) {
  uint8_t alivecounter;
  for (alivecounter=0; alivecounter<16; alivecounter++) {
      createCanMessage(alivecounter);
      printf("0x%02x 0x%02x 0x%02x\n", canMessage[0], canMessage[1], canMessage[2]);
  }
}

int main() {
  printf("Tesla CRC analysis\n");
  /* print the messages for all wanted switch positions */
  isFullDown = 0; isParkButton = 0; isFullUp = 0; isHalfDown = 0; printf("Idle position\n"); printMessages();
  isFullDown = 1; isParkButton = 0; isFullUp = 0; isHalfDown = 0; printf("Full down\n");     printMessages();
  isFullDown = 0; isParkButton = 1; isFullUp = 0; isHalfDown = 0; printf("park button\n");   printMessages();
  isFullDown = 0; isParkButton = 0; isFullUp = 1; isHalfDown = 0; printf("Full up\n");       printMessages();
  isFullDown = 0; isParkButton = 0; isFullUp = 0; isHalfDown = 1; printf("Half down\n");     printMessages();
  return 0;
}
